<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="com.cafe.erp.member.MemberDAO">

    <resultMap id="memberResultMap" type="com.cafe.erp.member.MemberDTO">
        <id property="memberId" column="member_id"/>
        <result property="memPassword" column="mem_password"/>
        <result property="memName" column="mem_name"/>
        <result property="memZipCode" column="mem_zip_code"/>        
        <result property="memAddress" column="mem_address"/>
        <result property="memAddressDetail" column="mem_address_detail"/>
        <result property="memEmail" column="mem_email"/>
        <result property="memPhone" column="mem_phone"/>
        <result property="memHireDate" column="mem_hire_date"/>
        <result property="memLeftDate" column="mem_left_date"/>
        <result property="memIsActive" column="mem_is_active"/>
        <result property="deptCode" column="dept_code"/>
        <result property="positionCode" column="position_code"/>
        <result property="positionCode" column="position_code"/>
    </resultMap>

    <select id="list" resultMap="memberResultMap">
		SELECT 
            M.member_id, M.mem_password, M.mem_name, M.mem_zip_code, 
            M.mem_address_detail, M.mem_email, M.mem_phone, 
            M.mem_hire_date, M.mem_left_date, M.mem_is_active, 
            M.dept_code, M.position_code, P.mem_position_sequence
        FROM 
            member M  
            LEFT JOIN member_dept D ON M.dept_code = D.member_dept_code
            LEFT JOIN member_position P ON M.position_code = P.member_position_code 
            ORDER BY
            	mem_is_active DESC,
            CASE	
                WHEN M.member_id = 999999 OR M.position_code = 99 THEN 0  
                WHEN M.position_code = 17 THEN 999                        
                ELSE P.mem_position_sequence END ASC,
            M.mem_hire_date ASC
	</select>
	
	<insert id="add" parameterType="MemberDTO">
		<selectKey keyProperty="memberId" resultType="int" order="BEFORE">
        SELECT 
            CONCAT(
                #{idPrefix}, DATE_FORMAT(NOW(), '%y'), 
                LPAD(IFNULL(MAX(CAST(SUBSTRING(member_id, 4) AS UNSIGNED)), 0) + 1,
                3, '0')
                )
        FROM member
        WHERE member_id LIKE CONCAT(#{idPrefix}, DATE_FORMAT(NOW(), '%y'), '%')
    </selectKey>
		INSERT INTO member 
		(member_id, mem_password, mem_name, mem_zip_code, mem_address, mem_address_detail, mem_email, mem_phone, mem_hire_date, mem_is_active, dept_code, position_code)
		VALUES
		(#{memberId}, 1234, #{memName}, #{memZipCode}, #{memAddress}, #{memAddressDetail}, #{memEmail}, #{memPhone},  #{memHireDate}, 1,  #{deptCode}, #{positionCode})
	</insert>
	
	
<!-- 	INSERT INTO member 
		(member_id, mem_password, mem_name, mem_zip_code, mem_address, mem_address_detail, mem_email, mem_phone, mem_hire_date, mem_is_active, dept_code, position_code)
		VALUES
		(member_id = #{memberId}, mem_password = #{memPassword}, mem_name = #{memName}, mem_zip_code = #{memZipCode}, mem_address = #{memAddress},
		 mem_address_detail = #{memAddress_detail}, mem_email = #{memEmail}, mem_phone = #{memPhone}, mem_hire_date = #{memHireDate}, 1, dept_code = #{memDeptCode}, position_code = #{memPositionCode}) -->
</mapper>