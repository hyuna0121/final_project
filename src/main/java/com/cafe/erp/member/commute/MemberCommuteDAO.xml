<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="com.cafe.erp.member.commute.MemberCommuteDAO">
	    <select id="attendanceList" parameterType="MemberCommuteDTO" resultType="MemberCommuteDTO">
		    SELECT * FROM (
		        SELECT 
		            member_commute_id,
		            mem_commute_work_date,
		            mem_commute_in_time,
		            mem_commute_out_time,
		            mem_commute_state,
		            member_id,
		            '' AS note
		        FROM member_commute
		        WHERE member_id = #{memberId}
		
		        UNION ALL
		
		        SELECT 
		            0                      AS memberCommuteId,
		            DATE(ma.mem_attendance_start_date) AS memCommuteWorkDate,
		            NULL                   AS memCommuteInTime,
		            NULL                   AS memCommuteOutTime,
		            ma.mem_attendance_type AS memCommuteState,
		            ma.member_id           AS memberId,
		            CONCAT(ma.mem_attendance_reason, ' (', ma.mem_attendance_used_days, '일)') AS note
		        FROM member_attendance ma
		        JOIN approval a ON ma.approval_id = a.approval_id
		        WHERE ma.member_id = #{memberId}
		          AND a.app_status = '승인'
		    ) AS combined_table
		    ORDER BY mem_commute_work_date DESC
		</select>
			    
	    
	    <insert id="checkIn" parameterType="MemberCommuteDTO">
	    	INSERT INTO member_commute (
	        mem_commute_work_date, 
	        mem_commute_in_time, 
	        mem_commute_state, 
	        member_id
	    )
	    SELECT CURDATE(), #{memCommuteInTime}, #{memCommuteState}, #{memberId}
	    FROM DUAL
	    WHERE NOT EXISTS (
	        SELECT 1 
	        FROM member_commute 
	        WHERE member_id = #{memberId} 
	          AND mem_commute_work_date = CURDATE()
	    );
	    </insert>
	    
	     <update id="checkOut" parameterType="MemberCommuteDTO">
		    UPDATE member_commute
		    SET mem_commute_out_time = #{memCommuteOutTime},
		        mem_commute_state = #{memCommuteState}
		    WHERE member_id = #{memberId}
		      AND mem_commute_work_date = CURDATE()
		      AND mem_commute_out_time IS NULL  
		 </update>
		 
		 
    </mapper> 