<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  
<mapper namespace="com.cafe.erp.receivable.ReceivableDAO">
  	
  	<sql id="receivableSearchBase">
  		FROM receivable r
  		
  		LEFT JOIN store_contract c
  			ON r.contract_id = c.contract_id
  		LEFT JOIN order_store so
  			ON r.store_order_id = so.store_order_id
 		JOIN store s 
  			ON s.store_id = COALESCE(c.store_id, so.store_id)
  		
  		WHERE r.receivable_type = 'R'
  		
  		<if test="baseMonth != null and baseMonth != ''">
  			AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
  		</if>
  		
  		<if test="storeName != null and storeName != ''">
  			AND s.store_name LIKE CONCAT('%',#{storeName},'%')
  		</if>
  	</sql>
  	
  	<sql id="receivableSourceTypeFilter">
	  <where>
	    <if test="sourceType == 'CONTRACT'">
	      EXISTS (
	        SELECT 1
	        FROM receivable r2
	        JOIN store_contract c2
	          ON r2.contract_id = c2.contract_id
	        WHERE r2.receivable_type = 'R'
	          AND r2.contract_id IS NOT NULL
	          AND c2.store_id = t.store_id
	          AND DATE_FORMAT(r2.receivable_date, '%Y-%m') = t.base_month
	      )
	    </if>
	
	    <if test="sourceType == 'ORDER'">
	      EXISTS (
	        SELECT 1
	        FROM receivable r2
	        JOIN order_store so2
	          ON r2.store_order_id = so2.store_order_id
	        WHERE r2.receivable_type = 'R'
	          AND r2.store_order_id IS NOT NULL
	          AND so2.store_id = t.store_id
	          AND DATE_FORMAT(r2.receivable_date, '%Y-%m') = t.base_month
	      )
	    </if>
	  </where>
	</sql>
  	
  	
  	
  	
  	
  	<!-- 가맹 미수금 조회 SQL -->
	<select 
	  id="receivableSearchList" 
	  parameterType="ReceivableSearchDTO"
	  resultType="ReceivableSummaryDTO">
	
	  SELECT
	    t.store_id,
	    t.store_name,
	    t.base_month,
	    t.total_amount
	  FROM (
	    SELECT
	      s.store_id,
	      s.store_name,
	      DATE_FORMAT(r.receivable_date, '%Y-%m') AS base_month,
	      SUM(rb.remain_amount) AS total_amount
	
	    FROM receivable r
	
	    LEFT JOIN (
	        SELECT
	            r2.receivable_id,
	            r2.receivable_total_amount
	            - IFNULL(SUM(rt.transaction_amount), 0) AS remain_amount
	        FROM receivable r2
	        LEFT JOIN receivable_transaction rt
	            ON r2.receivable_id = rt.receivable_id
	        WHERE r2.receivable_type = 'R'
	        GROUP BY
	            r2.receivable_id,
	            r2.receivable_total_amount
	    ) rb
	      ON r.receivable_id = rb.receivable_id
	      
	    LEFT JOIN store_contract c
	      ON r.contract_id = c.contract_id
	    LEFT JOIN order_store so
	      ON r.store_order_id = so.store_order_id
	    JOIN store s
	      ON s.store_id = COALESCE(c.store_id, so.store_id)
	
	    WHERE r.receivable_type = 'R'
	
	    <if test="baseMonth != null and baseMonth != ''">
	      AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
	    </if>
	
	    <if test="storeName != null and storeName != ''">
	      AND s.store_name LIKE CONCAT('%',#{storeName},'%')
	    </if>
	
	    GROUP BY
	      s.store_id,
	      s.store_name,
	      base_month
		HAVING SUM(rb.remain_amount) > 0
	  ) t
	  <include refid="receivableSourceTypeFilter"/>
	  ORDER BY t.base_month DESC
	  LIMIT #{pager.perPage}
	  OFFSET #{pager.startNum}
	</select>
  	
  	<!-- 페이지네이션 갯수 -->
	<select 
	  id="receivableSearchCount"
	  parameterType="ReceivableSearchDTO"
	  resultType="Long">
	
	  SELECT COUNT(*)
	  FROM (
	    SELECT
	      s.store_id,
	      DATE_FORMAT(r.receivable_date, '%Y-%m') AS base_month
	    FROM receivable r
	
	    LEFT JOIN (
	      SELECT
	        r2.receivable_id,
	        r2.receivable_total_amount
	        - IFNULL(SUM(rt.transaction_amount), 0) AS remain_amount
	      FROM receivable r2
	      LEFT JOIN receivable_transaction rt
	        ON r2.receivable_id = rt.receivable_id
	      WHERE r2.receivable_type = 'R'
	      GROUP BY
	        r2.receivable_id,
	        r2.receivable_total_amount
	    ) rb
	      ON r.receivable_id = rb.receivable_id
	
	    LEFT JOIN store_contract c
	      ON r.contract_id = c.contract_id
	    LEFT JOIN order_store so
	      ON r.store_order_id = so.store_order_id
	    JOIN store s
	      ON s.store_id = COALESCE(c.store_id, so.store_id)
	
	    WHERE r.receivable_type = 'R'
	
	    <if test="baseMonth != null and baseMonth != ''">
	      AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
	    </if>
	
	    <if test="storeName != null and storeName != ''">
	      AND s.store_name LIKE CONCAT('%',#{storeName},'%')
	    </if>
	
	    GROUP BY
	      s.store_id,
	      base_month
	
	    HAVING SUM(rb.remain_amount) > 0
	  ) t
	
	  <include refid="receivableSourceTypeFilter"/>
	
	</select>
  	
  	<!-- 물품대금 미수 내역 -->
  	<select id="orderSummary" parameterType="ReceivableSummaryDTO" resultType="com.cafe.erp.receivable.detail.ReceivableOrderSummaryDTO">
	  	SELECT
			r.receivable_id,
		    os.store_order_created_at  AS orderDate,
		    COUNT(*)         AS itemCount,
		    SUM(osd.store_order_amount)     AS supplyAmount,
		    SUM(floor(osd.store_order_amount*0.1)) AS taxAmount,
		    SUM(osd.store_order_amount+floor(osd.store_order_amount*0.1)) AS totalAmount
		FROM receivable r
		JOIN order_store os
			ON r.store_order_id = os.store_order_id
		JOIN order_store_detail osd
			ON os.store_order_id = osd.store_order_id
		JOIN vendor_item vi
			ON osd.item_id = vi.item_id
		LEFT JOIN vendor_item_price vip
			ON vip.item_id = vi.item_id
		WHERE r.receivable_type = 'R'
			AND os.store_id = #{storeId}
			AND DATE_FORMAT(os.store_order_created_at, '%Y-%m') = #{baseMonth}
			AND vip.item_price_enable = 0
		GROUP BY
		    r.receivable_id,
		    os.store_order_created_at
		ORDER BY os.store_order_created_at DESC;
  	</select>
  	
  	<!-- 상세 물품 대금 리스트 SQL -->
  	<select id="receivableItemList" parameterType="String" resultType="com.cafe.erp.receivable.detail.ReceivableItemDTO">
	  	SELECT
			os.store_order_created_at AS orderDate,
	    	vi.item_name AS itemName,
	    	osd.store_order_qty AS quantity,
	    	vip.item_supply_price AS unitPrice,
	    	osd.store_order_amount AS supplyAmount,
	    	FLOOR(osd.store_order_amount * 0.1) AS taxAmount,
	    	osd.store_order_amount + FLOOR(osd.store_order_amount * 0.1) AS totalAmount
		FROM
			receivable r
		JOIN order_store os
			ON r.store_order_id=os.store_order_id
		JOIN order_store_detail osd
			ON os.store_order_id = osd.store_order_id
		JOIN vendor_item vi
			ON osd.item_id = vi.item_id
		JOIN vendor_item_price vip
			ON vi.item_id = vip.item_id
		WHERE r.receivable_id = #{receivableId}
			AND vip.item_price_enable = 0
		ORDER BY vip.item_supply_price DESC
  	</select>
  	
	<!-- 상세 가맹비 미수 내역 -->
  	<select id="receivableRoyalty" parameterType="ReceivableSummaryDTO" resultType="com.cafe.erp.receivable.detail.ReceivableRoyaltyDTO">
	  	SELECT
		    r.receivable_id               AS receivableId,
		    sc.contract_start_date        AS contractDate,
		    r.receivable_supply_amount    AS supplyAmount,
		    r.receivable_tax_amount       AS taxAmount,
		    r.receivable_total_amount     AS totalAmount,
		    r.receivable_status           AS status
		FROM receivable r
		JOIN store_contract sc
		  ON r.contract_id = sc.contract_id
		WHERE sc.store_id = #{storeId}
		  AND r.receivable_type = 'R'
		  AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
		ORDER BY r.receivable_date DESC
  	</select>
  	
  <!-- 상세 금액 요약 -->
  <select id="selectAmountSummary"
        parameterType="ReceivableSummaryDTO"
        resultType="com.cafe.erp.receivable.detail.ReceivableAmountSummaryDTO">
	    SELECT
	        IFNULL(SUM(
	            CASE
	                WHEN r.contract_id IS NOT NULL
	                THEN r.receivable_total_amount
	                ELSE 0
	            END
	        ), 0) AS royaltyTotal,
	        IFNULL(SUM(
	            CASE
	                WHEN r.store_order_id IS NOT NULL
	                THEN r.receivable_total_amount
	                ELSE 0
	            END
	        ), 0) AS productTotal
	    FROM receivable r
	    LEFT JOIN store_contract sc
	        ON r.contract_id = sc.contract_id
	    LEFT JOIN order_store os
	        ON r.store_order_id = os.store_order_id
	    WHERE
	        (
	            (r.contract_id IS NOT NULL AND sc.store_id = #{storeId})
	         OR (r.store_order_id IS NOT NULL AND os.store_id = #{storeId})
	        )
	      AND r.receivable_type = 'R'
		  AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
	</select>

	<!-- 지급 내역 출력 -->
  	<select id="paidAmount" parameterType="ReceivableSummaryDTO" resultType="com.cafe.erp.receivable.detail.ReceivableTransactionDTO">
	  	SELECT
	    rt.transaction_date,
	    rt.transaction_amount,
	    rt.transaction_memo,
	    m.mem_name AS memberName,
	    CASE
	        WHEN r.contract_id IS NOT NULL THEN 'CONTRACT'
	        WHEN r.store_order_id IS NOT NULL THEN 'ORDER'
	    END AS source_type
	    
		FROM receivable_transaction rt
		JOIN receivable r
		  ON rt.receivable_id = r.receivable_id
		LEFT JOIN store_contract sc
		  ON r.contract_id = sc.contract_id
		LEFT JOIN order_store os
		  ON r.store_order_id = os.store_order_id
		LEFT JOIN member m
		  ON rt.member_id = m.member_id
		JOIN store s
		  ON s.store_id = COALESCE(sc.store_id, os.store_id)
		WHERE s.store_id = #{storeId}
		AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
		ORDER BY rt.transaction_date DESC;
  	</select>
  	
  	<!-- 지급 처리 폼 목록 -->
  	<select id="getAvailableReceivables" parameterType="ReceivableSummaryDTO" resultType="com.cafe.erp.receivable.detail.ReceivableAvailableDTO">
		  	SELECT
		    	r.receivable_id,
		    	r.receivable_total_amount
		      		- COALESCE(SUM(rt.transaction_amount), 0) AS remain_amount,
		    	CASE
		        	WHEN r.contract_id IS NOT NULL THEN 'CONTRACT'
		        	WHEN r.store_order_id IS NOT NULL THEN 'ORDER'
		    	END AS sourceType
			FROM receivable r
			LEFT JOIN receivable_transaction rt
		  		ON r.receivable_id = rt.receivable_id
		  	WHERE (
		   	 r.contract_id IN (
		   	     SELECT c.contract_id
		    	 FROM store_contract c
		         WHERE c.store_id = #{storeId}
		    )
		    OR
		    r.store_order_id IN (
		        SELECT o.store_order_id
		        FROM order_store o
		        WHERE o.store_id = #{storeId}
		    )
		)
      	  AND r.receivable_type = 'R'
      	  AND DATE_FORMAT(r.receivable_date, '%Y-%m') = #{baseMonth}
		GROUP BY r.receivable_id, r.receivable_total_amount,
		         r.contract_id, r.store_order_id
		HAVING remain_amount > 0;
  	</select>
  	
  	
  	<!-- 지급 내역 삽입 -->
  	<insert id="insertCollection" parameterType="com.cafe.erp.receivable.detail.ReceivableCollectionRequestDTO">
	    INSERT INTO receivable_transaction (
	        transaction_type,
	        transaction_amount,
	        transaction_date,
	        transaction_memo,
	        receivable_id,
	        member_id
	    ) VALUES (
	        'C',
	        #{amount},
	        NOW(),
	        #{memo},
	        #{receivableId},
	        #{memberId}
	    )
	</insert>
  	<!-- 남은 금액 -->
  	<select id="selectRemainAmount" parameterType="string" resultType="int">
	    SELECT
	        r.receivable_total_amount
	        - IFNULL(SUM(t.transaction_amount), 0) AS remain_amount
	    FROM receivable r
	    LEFT JOIN receivable_transaction t
	        ON r.receivable_id = t.receivable_id
	        AND t.transaction_type = 'C'
	    WHERE r.receivable_id = #{receivableId}
	    GROUP BY r.receivable_total_amount
	</select>
  	<!-- 채권 총금액 -->
  	<select id="selectTotalAmount" parameterType="string" resultType="int">
	    SELECT receivable_total_amount
	    FROM receivable
	    WHERE receivable_id = #{receivableId}
	</select>
  	<!-- receivable table status 컬럼 업데이트 -->
  	<update id="updateReceivableStatus">
	    UPDATE receivable
	    SET receivable_status = #{status}
	    WHERE receivable_id = #{receivableId}
	</update>
	
	<!-- 매월 1일 채권 자동생성 -->
	<insert id="insertMonthlyRoyaltyReceivable">
	
		INSERT INTO receivable (
		    receivable_id,
		    receivable_type,
		    receivable_supply_amount,
		    receivable_tax_amount,
		    receivable_total_amount,
		    receivable_date,
		    receivable_status,
		    contract_id
		)SELECT
			CONCAT(
			'RCV-',
			'R',
			'-',
			DATE_FORMAT(CURDATE(), '%Y%m'),
			'-',
			sc.contract_id
		    ) AS receivable_id,
		    'R' AS receivable_type,                     
		    sc.contract_royalti AS supply_amount,       
		    sc.contract_royalti * 0.1 AS tax_amount,
		    sc.contract_royalti * 1.1 AS total_amount,
		    DATE_FORMAT(CURDATE(), '%Y-%m-01') AS receivable_date,
		    'O' AS receivable_status,
		    sc.contract_id
		FROM store_contract sc
		LEFT JOIN receivable r
		    ON r.contract_id = sc.contract_id
		   AND r.receivable_type = 'R'
		   AND r.receivable_date = DATE_FORMAT(CURDATE(), '%Y-%m-01')
		WHERE sc.contract_status = 1
		  AND DATE_FORMAT(CURDATE(), '%Y-%m-01')
		      BETWEEN sc.contract_start_date AND sc.contract_end_date
		  AND r.receivable_id IS NULL;
	</insert>
	
	
	
	
	
	
	
	
	
	
	
	
	
</mapper>
