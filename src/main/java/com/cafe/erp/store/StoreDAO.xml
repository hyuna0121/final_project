<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.cafe.erp.store.StoreDAO">

	<sql id="searchCondition">
        <where>
            <if test="storeStatus != null and storeStatus != ''">
                AND s.store_status = #{storeStatus}
            </if>
            
            <if test="storeAddress != null and storeAddress != ''">
                AND s.store_address LIKE CONCAT('%', #{storeAddress}, '%')
            </if>
            
            <if test="storeName != null and storeName != ''">
                AND s.store_name LIKE CONCAT('%', #{storeName}, '%')
            </if>
            
            <if test="storeStartTime != null and storeStartTime != ''">
            	AND s.store_start_time >= #{storeStartTime}
	        </if>
	
	        <if test="storeCloseTime != null and storeCloseTime != ''">
	            AND s.store_close_time &lt;= #{storeCloseTime}
	        </if>
    	</where>
    </sql>

	<select id="list" parameterType="StoreSearchDTO" resultType="StoreDTO">
		SELECT 
            s.store_id,
            s.store_name,          
            s.member_id,
            s.store_address,
            s.store_zonecode,
            s.store_latitude,
            s.store_longitude,
            s.store_status,
            s.store_start_time,
            s.store_close_time,
            s.store_created_at,
            s.store_updated_at,
            m.mem_name
        FROM 
            store s             
            LEFT JOIN member m                
            ON s.member_id = m.member_id 
      	<include refid="searchCondition" />
		<choose>
			<when test="sortConditions != null and sortConditions.size() > 0">
				ORDER BY
				<foreach collection="sortConditions" item="sort" separator=",">
					<choose>
						<when test="sort.field == 'storeId'"> s.store_id </when>
						<when test="sort.field == 'storeName'"> s.store_name </when>
						<when test="sort.field == 'storeOwnerName'"> m.mem_name </when>
						<when test="sort.field == 'storeAddress'"> s.store_address </when>
						<when test="sort.field == 'storeStatus'"> s.store_status </when>
						<when test="sort.field == 'storeStartTime'"> s.store_start_time </when>
						<when test="sort.field == 'storeCloseTime'"> s.store_close_time </when>
					</choose>

					<if test="sort.dir == 'DESC'"> DESC </if>
					<if test="sort.dir == 'ASC'"> ASC </if>
				</foreach>
			</when>
			<otherwise>
				ORDER BY s.store_id
			</otherwise>
		</choose>
        LIMIT #{startNum}, #{perPage}
	</select>

	<select id="maxStoreId" parameterType="String" resultType="Integer">
		SELECT MAX(store_id) FROM store WHERE CAST(store_id AS CHAR) LIKE CONCAT(#{id}, '%') FOR UPDATE
	</select>
	
	<insert id="add" parameterType="storeDTO">
		INSERT INTO store 
		VALUE (#{storeId}, #{storeName}, #{memberId}, #{storeAddress}, #{storeLatitude}, #{storeLongitude}, "오픈 준비", null, null, now(), now(), #{storeZonecode});
	</insert>
	
	<select id="searchStore" parameterType="String">
		SELECT 
            s.store_id,
            s.store_name,          
            s.member_id,
            s.store_address,
            s.store_zonecode,
            s.store_latitude,
            s.store_longitude,
            s.store_status,
            s.store_start_time,
            s.store_close_time,
            s.store_created_at,
            s.store_updated_at,
            m.mem_name
        FROM 
            store s             
            LEFT JOIN member m                
            ON s.member_id = m.member_id 
            WHERE s.store_name LIKE CONCAT(#{keyword}, '%')
            ORDER BY s.store_name
	</select>
	
	<select id="count" parameterType="StoreSearchDTO" resultType="Long">
		SELECT COUNT(store_id) FROM store s
		<include refid="searchCondition" />
	</select>
	
	<select id="excelList" parameterType="StoreSearchDTO" resultType="StoreDTO">
		SELECT 
           s.store_id,
           s.store_name,          
           s.member_id,
           m.mem_name,
           s.store_address,
           s.store_status,
           s.store_start_time,
           s.store_close_time
       FROM 
           store s             
           LEFT JOIN member m                
           ON s.member_id = m.member_id
		<include refid="searchCondition" />
		<choose>
			<when test="sortConditions != null and sortConditions.size() > 0">
				ORDER BY
				<foreach collection="sortConditions" item="sort" separator=",">
					<choose>
						<when test="sort.field == 'storeId'"> s.store_id </when>
						<when test="sort.field == 'storeName'"> s.store_name </when>
						<when test="sort.field == 'storeOwnerName'"> m.mem_name </when>
						<when test="sort.field == 'storeAddress'"> s.store_address </when>
						<when test="sort.field == 'storeStatus'"> s.store_status </when>
						<when test="sort.field == 'storeStartTime'"> s.store_start_time </when>
						<when test="sort.field == 'storeCloseTime'"> s.store_close_time </when>
					</choose>

					<if test="sort.dir == 'DESC'"> DESC </if>
					<if test="sort.dir == 'ASC'"> ASC </if>
				</foreach>
			</when>
			<otherwise>
				ORDER BY s.store_id
			</otherwise>
		</choose>
	</select>
	
	<select id="detail" parameterType="StoreDTO" resultType="StoreDTO">
		SELECT  
			s.store_id,
			s.store_name,
			s.store_address,
			s.store_latitude,
			s.store_longitude,
			store_zonecode,
			s.store_status,
			s.store_start_time,
			s.store_close_time,
			s.store_created_at,
			s.member_id,
			m.mem_name,
			m.mem_email,
			m.mem_phone
		FROM store s LEFT JOIN member m ON s.member_id = m.member_id 
		WHERE store_id = #{storeId};
	</select>
	
	<select id="manageList" parameterType="StoreDTO" resultType="StoreManageDTO">
		SELECT 
			smh.manage_id,
			smh.manage_start_date,
			smh.manage_end_date,
			smh.member_id,
			m.mem_name
		FROM store_manager_history smh 
		LEFT JOIN member m ON smh.member_id = m.member_id
		WHERE store_id = #{storeId}
		ORDER BY smh.manage_start_date DESC
	</select>
	
	<update id="updateToEnd" parameterType="StoreManageDTO">
		UPDATE store_manager_history
		SET manage_end_date = DATE_SUB(#{manageStartDate}, INTERVAL 1 DAY)
		WHERE store_id = #{storeId}
		AND manage_end_date IS NULL
	</update>
	
	<insert id="addManager" parameterType="StoreManageDTO">
		INSERT INTO store_manager_history
		VALUE (null, #{storeId}, #{memberId}, #{manageStartDate}, null)
	</insert>

	<select id="findByMemberId" parameterType="int" resultType="StoreDTO">
		SELECT * FROM store WHERE member_id = #{memberId}
	</select>

    <select id="searchMyStore" resultType="StoreDTO">
		SELECT
			s.store_id,
			s.store_name,
			s.member_id,
			s.store_address,
			s.store_zonecode,
			s.store_latitude,
			s.store_longitude,
			s.store_status,
			s.store_start_time,
			s.store_close_time,
			s.store_created_at,
			s.store_updated_at,
			m.mem_name
		FROM
		store s
		LEFT JOIN member m ON s.member_id = m.member_id
		LEFT JOIN store_manager_history smh ON s.store_id = smh.store_id
		WHERE smh.member_id = #{memberId}
		AND manage_end_date IS NULL
		AND	s.store_name LIKE CONCAT(#{keyword}, '%')
		ORDER BY s.store_name
	</select>

</mapper>