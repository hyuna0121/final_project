<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cafe.erp.store.voc.VocDAO">

	<sql id="searchCondition">
        <where>
			<if test="searchStoreId != null">
				AND v.store_id = #{searchStoreId}
			</if>

            <if test="searchVocType != null and searchVocType != ''">
                AND v.voc_type = #{searchVocType}
            </if>
            
            <if test="searchVocStatus != null">
                AND v.voc_status = #{searchVocStatus}
            </if>
            
            <if test="searchStartDate != null">
	            AND v.voc_created_at >= CONCAT(#{searchStartDate}, ' 00:00:00')
	        </if>
	        
	        <if test="searchEndDate != null">
	            AND v.voc_created_at &lt;= CONCAT(#{searchEndDate}, ' 23:59:59')
	        </if>
	        
	        <if test="searchStoreName != null and searchStoreName != ''">
                AND s.store_name LIKE CONCAT('%', #{searchStoreName}, '%')
            </if>
	
	        <if test="searchVocTitle != null and searchVocTitle != ''">
                AND v.voc_title LIKE CONCAT('%', #{searchVocTitle}, '%')
            </if>
    	</where>
    </sql>

	<select id="list" parameterType="VocSearchDTO" resultType="VocDTO">
		SELECT 
			v.voc_id,
			v.member_id,
			m.mem_name,
			v.store_id,
			s.store_name,
			v.voc_title,
			v.voc_type,
			v.voc_status,
			v.voc_created_at
		FROM voc v
			LEFT JOIN member m ON v.member_id = m.member_id
			LEFT JOIN store s ON v.store_id = s.store_id
		<include refid="searchCondition" />
		<choose>
			<when test="sortConditions != null and sortConditions.size() > 0">
				ORDER BY
				<foreach collection="sortConditions" item="sort" separator=",">
					<choose>
						<when test="sort.field == 'vocId'"> v.voc_id </when>
						<when test="sort.field == 'storeName'"> s.store_name </when>
						<when test="sort.field == 'type'"> v.voc_type </when>
						<when test="sort.field == 'title'"> v.voc_title </when>
						<when test="sort.field == 'writer'"> m.mem_name </when>
						<when test="sort.field == 'status'"> v.voc_status </when>
						<when test="sort.field == 'datetime'"> v.voc_created_at </when>
						<otherwise> voc_id DESC </otherwise>
					</choose>

					<if test="sort.dir == 'DESC'"> DESC </if>
					<if test="sort.dir == 'ASC'"> ASC </if>
				</foreach>
			</when>
			<otherwise>
				ORDER BY v.voc_created_at DESC
			</otherwise>
		</choose>
		LIMIT #{startNum}, #{perPage}
	</select>
	
	<insert id="add" parameterType="VocDTO" useGeneratedKeys="true" keyProperty="vocId">
		INSERT INTO voc(member_id, store_id, voc_title , voc_type, voc_contact, voc_contents, voc_status, voc_created_at, voc_updated_at) 
		VALUES (#{memberId}, #{storeId}, #{vocTitle}, #{vocType}, #{vocContact}, #{vocContents}, 0, now(), now())
	</insert>

	<update id="editVoc" parameterType="VocDTO">
		UPDATE voc
		SET voc_title = #{vocTitle}, voc_contents = #{vocContents}, voc_updated_at = now()
		WHERE voc_id = #{vocId}
	</update>

	<update id="editStatus" parameterType="Integer">
		UPDATE voc
		SET voc_status = 2, voc_updated_at = now()
		WHERE voc_id = #{vocId}
	</update>

	<!-- 알림 용 가맹점주 정보 -->
	<select id="vocOnwerInfo" parameterType="VocDTO" resultType="VocDTO">
	    SELECT
	        m.member_id AS ownerId,
	        m.mem_name  AS ownerName
	    FROM store s
	    JOIN member m
	        ON m.member_id = s.member_id
	    WHERE s.store_id = #{storeId}
	</select>
	<!-- 알림 용 voc 작성자 조회 -->
	<select id="findWriterName" parameterType="int" resultType="string">
	    SELECT mem_name
	    FROM member
	    WHERE member_id = #{memberId}
	</select>
	
	<select id="detail" parameterType="Integer" resultType="VocDTO">
		SELECT 
		    v.voc_id,
		    v.member_id,
		    m.mem_name,
		    v.store_id,
		    s.store_name,
		    o.mem_name AS owner_name,  
		    s.store_address,
		    v.voc_title,
		    v.voc_contact,
		    v.voc_contents,
		    v.voc_type,
		    v.voc_status,
		    v.voc_created_at,
		    v.voc_updated_at
		FROM voc v
		    LEFT JOIN member m ON v.member_id = m.member_id  
		    LEFT JOIN store s ON v.store_id = s.store_id       
		    LEFT JOIN member o ON s.member_id = o.member_id    
		WHERE v.voc_id = #{vocId}
	</select>
	
	<select id="processList" parameterType="Integer" resultMap="processResult">
		SELECT 
			vp.process_id,
			vp.member_id,
			m.mem_name,
		    vp.process_contents,
		    vp.process_created_at,
		    vp.process_is_deleted,
		    vpf.file_id,
		    vpf.file_saved_name,
            vpf.file_original_name
		FROM voc_process vp
		LEFT JOIN member m ON vp.member_id = m.member_id
		LEFT JOIN voc_process_file vpf ON vp.process_id = vpf.process_id
		WHERE voc_id = #{vocId}
		ORDER BY process_created_at
	</select>
	
	<resultMap type="VocProcessDTO" id="processResult">
		<id column="process_id" property="processId"/>
		<result column="member_id" property="memberId"/>
		<result column="mem_name" property="memName"/>
		<result column="process_contents" property="processContents"/>
		<result column="process_created_at" property="processCreatedAt"/>
		<result column="process_is_deleted" property="processIsDeleted"/>
		
		<collection property="fileDTOs" ofType="VocProcessFileDTO">
			<id column="file_id" property="fileId"/>
			<result column="file_original_name" property="fileOriginalName"/>
			<result column="file_saved_name" property="fileSavedName"/>
		</collection>
	</resultMap>
	
	<insert id="addProcess" parameterType="VocProcessDTO" useGeneratedKeys="true" keyProperty="processId">
		INSERT INTO voc_process(voc_id, member_id, process_contents, process_created_at, process_is_deleted) 
		VALUES (#{vocId}, #{memberId}, #{processContents}, now(), 0)
	</insert>
	
	<select id="count" parameterType="VocSearchDTO" resultType="Long">
		SELECT COUNT(voc_id) FROM voc v LEFT JOIN store s ON v.store_id = s.store_id
		<include refid="searchCondition" />
	</select>
	
	<select id="excelList" parameterType="VocSearchDTO" resultType="VocDTO">		
		SELECT 
		    v.voc_id,
		    v.member_id,
		    m.mem_name,
		    v.store_id,
		    s.store_name,
		    s.member_id AS owner_id,
		    o.mem_name AS owner_name,  
		    s.store_address,
		    v.voc_title,
		    v.voc_contact,
		    v.voc_contents,
		    v.voc_type,
		    v.voc_status,
		    v.voc_created_at,
		    v.voc_updated_at
		FROM voc v
		    LEFT JOIN member m ON v.member_id = m.member_id  
		    LEFT JOIN store s ON v.store_id = s.store_id       
		    LEFT JOIN member o ON s.member_id = o.member_id    
		<include refid="searchCondition" />
		<choose>
			<when test="sortConditions != null and sortConditions.size() > 0">
				ORDER BY
				<foreach collection="sortConditions" item="sort" separator=",">
					<choose>
						<when test="sort.field == 'vocId'"> v.voc_id </when>
						<when test="sort.field == 'storeName'"> s.store_name </when>
						<when test="sort.field == 'type'"> v.voc_type </when>
						<when test="sort.field == 'title'"> v.voc_title </when>
						<when test="sort.field == 'writer'"> m.mem_name </when>
						<when test="sort.field == 'status'"> v.voc_status </when>
						<when test="sort.field == 'datetime'"> v.voc_created_at </when>
					</choose>

					<if test="sort.dir == 'DESC'"> DESC </if>
					<if test="sort.dir == 'ASC'"> ASC </if>
				</foreach>
			</when>
			<otherwise>
				ORDER BY v.voc_created_at DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="addFile" parameterType="VocProcessFileDTO">
		INSERT INTO voc_process_file VALUE(null, #{processId}, #{fileOriginalName}, #{fileSavedName})	
	</insert>
	
	
	<sql id="statCondition">
        <where>
	        <if test="year != null and year != ''">
	            AND DATE_FORMAT(voc_created_at, '%Y') = #{year}
	        </if>
	        
	        <if test="month != null and month != ''">
	            AND DATE_FORMAT(voc_created_at, '%m') = #{month}
	        </if>
    	</where>
    </sql>

	<select id="trend" resultType="VocStatDTO">
        SELECT 
            DATE_FORMAT(voc_created_at, '%d') AS category,
            COUNT(*) AS count
        FROM voc
		<include refid="statCondition" />
        GROUP BY DATE_FORMAT(voc_created_at, '%Y-%m-%d')
        ORDER BY category ASC
    </select>
    
    <select id="countByType" resultType="VocStatDTO">
        SELECT 
            voc_type AS category,
            COUNT(*) AS count
        FROM voc
		<include refid="statCondition" />        
        GROUP BY voc_type
        ORDER BY voc_type, count DESC
    </select>
    
    <select id="topComplaintStores" resultType="VocStatDTO">
	    SELECT 
	    	s.store_id AS active_count,
	        s.store_name AS category,      
	        s.store_address AS description, 
	        COUNT(v.voc_id) AS count
	    FROM voc v
	    JOIN store s ON v.store_id = s.store_id
		<include refid="statCondition" />
	    GROUP BY s.store_id
	    ORDER BY count DESC, category ASC
	    LIMIT 5
	</select>
	
	<select id="summary" resultType="map">
	    SELECT 
	        COUNT(voc_id) AS total,
	        COUNT(CASE WHEN voc_status = 2 THEN 1 END) AS resolved,
	        COUNT(CASE WHEN voc_status != 2 THEN 1 END) AS pending,
	        IFNULL(ROUND(AVG(
	            CASE WHEN voc_status = 2 
	            THEN TIMESTAMPDIFF(HOUR, voc_created_at, voc_updated_at) 
	            ELSE NULL END
	        ), 1), 0) AS avgTime
	    FROM voc
	    <include refid="statCondition" />
	</select>
	
	<update id="updateToActive" parameterType="Integer">
		UPDATE voc 
		SET voc_status = 1, voc_updated_at = now()
		WHERE voc_id = #{vocId}
	</update>
	
	<select id="managerPerformance" resultType="VocStatDTO">
	    SELECT 
	        m.mem_name AS category,  
	        COUNT(CASE WHEN v.voc_status = 2 THEN 1 END) AS count,
	        COUNT(CASE WHEN v.voc_status = 1 THEN 1 END) AS activeCount,
			COUNT(CASE WHEN v.voc_status = 0 THEN 1 END) AS pendingCount,
	        IFNULL(ROUND(AVG(
	            CASE WHEN v.voc_status = 2 
	            THEN TIMESTAMPDIFF(HOUR, v.voc_created_at, v.voc_updated_at) 
	            ELSE NULL END
	        ), 1), 0) AS avgTime
	    FROM voc v
	    JOIN store_manager_history h 
	      ON v.store_id = h.store_id
	      AND v.voc_created_at >= h.manage_start_date 
	      AND (h.manage_end_date IS NULL OR v.voc_created_at &lt;= h.manage_end_date)
	    JOIN member m ON h.member_id = m.member_id
		<include refid="statCondition" />
	    GROUP BY m.member_id
	    ORDER BY count DESC 
	    LIMIT 6
    </select>

    <select id="fileListById" parameterType="Integer" resultType="VocProcessFileDTO">
		SELECT * FROM voc_process_file WHERE process_id = #{processId}
	</select>

	<select id="getProcess" parameterType="Integer" resultType="VocProcessDTO">
		SELECT * FROM voc_process WHERE process_id = #{processId}
	</select>

	<delete id="deleteFile">
		DELETE FROM voc_process_file WHERE process_id = #{processId}
	</delete>

	<update id="deleteProcess" parameterType="Integer">
		UPDATE voc_process
		SET process_is_deleted = 1
		WHERE process_id = #{processId}
	</update>
</mapper>