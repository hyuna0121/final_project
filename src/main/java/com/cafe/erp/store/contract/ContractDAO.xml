<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.cafe.erp.store.contract.ContractDAO">

	<sql id="searchCondition">
        <where>
			<if test="searchStoreId != null">
				AND sc.store_id = #{searchStoreId}
			</if>

            <if test="searchContractStatus != null">
                AND sc.contract_status = #{searchContractStatus}
            </if>
            
            <if test="searchStartDate != null">
	            AND sc.contract_start_date >= #{searchStartDate}
	        </if>
	        
	        <if test="searchEndDate != null">
	            AND sc.contract_end_date &lt;= #{searchEndDate}
	        </if>
	        
	        <if test="searchStoreName != null and searchStoreName != ''">
                AND s.store_name LIKE CONCAT('%', #{searchStoreName}, '%')
            </if>
	
	        <if test="searchRoyaltyMin != null">
                AND sc.contract_royalti >= #{searchRoyaltyMin}
            </if>
            
            <if test="searchRoyaltyMax != null">
                AND sc.contract_royalti &lt;= #{searchRoyaltyMax}
            </if>
            
            <if test="searchDepositMin != null">
                AND sc.contract_deposit >= #{searchDepositMin}
            </if>
            
            <if test="searchDepositMax != null">
                AND sc.contract_deposit &lt;= #{searchDepositMax}
            </if>
    	</where>
    </sql>

	<select id="list" parameterType="ContractSearchDTO" resultType="ContractDTO">
		SELECT 
            sc.contract_id,
            sc.store_id,          
            sc.contract_royalti,
            sc.contract_deposit,
            sc.contract_start_date,
            sc.contract_end_date,
            sc.contract_status,
            sc.contract_created_at,
            sc.contract_updated_at,
            s.store_name
        FROM 
            store_contract sc             
            INNER JOIN store s ON sc.store_id = s.store_id 
        <include refid="searchCondition" />
		<choose>
			<when test="sortConditions != null and sortConditions.size() > 0">
				ORDER BY
				<foreach collection="sortConditions" item="sort" separator=",">
					<choose>
						<when test="sort.field == 'contractId'"> sc.contract_id </when>
						<when test="sort.field == 'storeName'"> s.store_name </when>
						<when test="sort.field == 'royalti'"> sc.contract_royalti </when>
						<when test="sort.field == 'deposit'"> sc.contract_deposit </when>
						<when test="sort.field == 'startDate'"> sc.contract_start_date </when>
						<when test="sort.field == 'endDate'"> sc.contract_end_date </when>
						<when test="sort.field == 'status'"> sc.contract_status </when>
						<otherwise> sc.contract_id DESC </otherwise>
					</choose>

					<if test="sort.dir == 'DESC'"> DESC </if>
					<if test="sort.dir == 'ASC'"> ASC </if>
				</foreach>
			</when>
			<otherwise>
				ORDER BY sc.contract_id DESC
			</otherwise>
		</choose>
        LIMIT #{startNum}, #{perPage}
	</select>
	
	<select id="maxContractId" parameterType="String" resultType="String">
		SELECT MAX(contract_id) FROM store_contract WHERE contract_id LIKE CONCAT(#{prefix}, '%') FOR UPDATE
	</select>

	<insert id="add" parameterType="ContractDTO">
		INSERT INTO store_contract VALUE(#{contractId}, #{storeId}, #{contractRoyalti}, #{contractDeposit}, #{contractStartDate}, #{contractEndDate}, #{contractStatus}, now(), now())
	</insert>
	
	<insert id="addFile" parameterType="ContractFileDTO">
		INSERT INTO store_contract_file	VALUE(null, #{contractId}, #{fileOriginalName}, #{fileSavedName})	
	</insert>
	
	<select id="getDetail" parameterType="String" resultMap="detailResult">
		SELECT 
			sc.contract_id,
            sc.store_id,          
            sc.contract_royalti,
            sc.contract_deposit,
            sc.contract_start_date,
            sc.contract_end_date,
            sc.contract_status,
            sc.contract_created_at,
            sc.contract_updated_at,
            s.store_name,
            s.store_address,
            m.mem_name,
            scf.file_id,
            scf.file_original_name,
            scf.file_saved_name
		FROM store_contract sc
		INNER JOIN store s ON sc.store_id = s.store_id 
		INNER JOIN member m ON s.member_id = m.member_id
		LEFT JOIN  store_contract_file scf ON sc.contract_id=scf.contract_id
		WHERE sc.contract_id = #{contractId};
	</select>
	
	<resultMap type="ContractDTO" id="detailResult">
		<id column="contract_id" property="contractId"/>
		<result column="store_id" property="storeId"/>
		<result column="contract_royalti" property="contractRoyalti"/>
		<result column="contract_deposit" property="contractDeposit"/>
		<result column="contract_start_date" property="contractStartDate"/>
		<result column="contract_end_date" property="contractEndDate"/>
		<result column="contract_status" property="contractStatus"/>
		<result column="contract_created_at" property="contractCreatedAt"/>
		<result column="contract_updated_at" property="contractUpdatedAt"/>
		<result column="store_name" property="storeName"/>
		<result column="store_address" property="storeAddress"/>
		<result column="mem_name" property="memName"/>
		
		<collection property="fileDTOs" ofType="ContractFileDTO">
			<id column="file_id" property="fileId"/>
			<result column="file_original_name" property="fileOriginalName"/>
			<result column="file_saved_name" property="fileSavedName"/>
		</collection>
	</resultMap>
	
	<update id="updateStatusToActive" parameterType="java.time.LocalDate">
		UPDATE store_contract SET contract_status = 1 WHERE contract_start_date = #{today}
	</update>
	
	<update id="updateStatusToExpired" parameterType="java.time.LocalDate">
		UPDATE store_contract SET contract_status = 2 WHERE contract_end_date = #{yesterday}
	</update>
	
	<update id="update">
		UPDATE store_contract 
		SET 
			contract_royalti = #{contractRoyalti}, 
			contract_deposit = #{contractDeposit}, 
			contract_start_date = #{contractStartDate}, 
			contract_end_date = #{contractEndDate}, 
			contract_status = #{contractStatus}, 
			contract_updated_at = now() 
		WHERE contract_id = #{contractId}
	</update>
	
	<select id="selectFile" parameterType="Integer" resultType="ContractFileDTO">
		SELECT * FROM store_contract_file WHERE file_id = #{fileId}
	</select>
	
	<delete id="deleteFile" parameterType="Integer">
		DELETE FROM store_contract_file WHERE file_id = #{fileId}
	</delete>
	
	<select id="count" parameterType="ContractSearchDTO" resultType="Long">
		SELECT COUNT(contract_id) 
		FROM store_contract sc
		INNER JOIN store s ON sc.store_id = s.store_id
		<include refid="searchCondition" />
	</select>
	
	<select id="excelList" parameterType="ContractSearchDTO" resultType="ContractDTO">
		SELECT 
            sc.contract_id,
            sc.store_id,          
            sc.contract_royalti,
            sc.contract_deposit,
            sc.contract_start_date,
            sc.contract_end_date,
            sc.contract_status,
            sc.contract_created_at,
            sc.contract_updated_at,
            s.store_name,
            s.member_id,
		    m.mem_name,
		    s.store_address
        FROM 
            store_contract sc             
            INNER JOIN store s ON sc.store_id = s.store_id 
            LEFT JOIN member m ON s.member_id = m.member_id
        <include refid="searchCondition" />
		<choose>
			<when test="sortConditions != null and sortConditions.size() > 0">
				ORDER BY
				<foreach collection="sortConditions" item="sort" separator=",">
					<choose>
						<when test="sort.field == 'contractId'"> sc.contract_id </when>
						<when test="sort.field == 'storeName'"> s.store_name </when>
						<when test="sort.field == 'royalti'"> sc.contract_royalti </when>
						<when test="sort.field == 'deposit'"> sc.contract_deposit </when>
						<when test="sort.field == 'startDate'"> sc.contract_start_date </when>
						<when test="sort.field == 'endDate'"> sc.contract_end_date </when>
						<when test="sort.field == 'status'"> sc.contract_status </when>
					</choose>

					<if test="sort.dir == 'DESC'"> DESC </if>
					<if test="sort.dir == 'ASC'"> ASC </if>
				</foreach>
			</when>
			<otherwise>
				ORDER BY sc.contract_id DESC
			</otherwise>
		</choose>
	</select>
	
</mapper>