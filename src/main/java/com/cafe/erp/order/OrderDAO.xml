<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.cafe.erp.order.OrderDAO">
    	<select id="selectMaxOrderHqId" resultType="String">
			select MAX(hq_order_id)
			from order_hq
			where hq_order_id LIKE CONCAT(#{prefix}, #{orderDate}, '%')    	
    	</select>
    	<select id="selectMaxOrderStoreId" resultType="String">
			select MAX(store_order_id)
			from order_store
			where store_order_id LIKE CONCAT(#{prefix}, #{orderDate}, '%')    	
    	</select>
    	
    	<select id="selectStoreId" parameterType="Integer" resultType="OrderDTO">
    		select store_id, store_name from store where member_id = #{memberId}
    	</select>
    	
    	<!-- 발주 추가 -->
    	<insert id="insertHqOrder" parameterType="OrderDTO">
    		insert into order_hq values(
    		#{hqOrderId}, 
    		NOW(),
    		<choose>
	            <when test="hqOrderStatus == 100">
	                NULL
	            </when>
	            <when test="hqOrderStatus == 200">
	                NOW()
	            </when>
	        </choose>, 
	        #{hqOrderStatus}, 
	        #{memberId}, 
	        #{hqOrderTotalAmount});
    	</insert>
    	<insert id="insertStoreOrder" parameterType="OrderDTO">
    		insert into order_store values(
    		#{hqOrderId}, 
    		now(), 
    		<choose>
	            <when test="hqOrderStatus == 100">
	                NULL
	            </when>
	            <when test="hqOrderStatus == 200">
	                NOW()
	            </when>
	        </choose>, 
    		#{hqOrderStatus}, 
    		null, 
    		#{storeId}, 
    		#{memberId}, 
    		#{hqOrderTotalAmount}, 
    		null);
    	</insert>
    	
    	<!-- 발주 상세 추가 -->
    	<insert id="insertHqOrderItemDetail" parameterType="OrderDetailDTO">
    		insert into order_hq_detail 
    		(
    			hq_order_detail_id,
    			hq_order_qty,
    			hq_order_price,
    			hq_order_amount,
    			hq_order_created_at,
    			vendor_code,
    			hq_order_id,
    			item_id,
    			hq_order_item_code,
    			hq_order_item_name
    		)
    		values(null, #{hqOrderQty}, #{hqOrderPrice}, #{hqOrderAmount}, now(), #{vendorCode}, #{hqOrderId}, #{itemId}, #{hqOrderItemCode}, #{hqOrderItemName});
    	</insert>
    	<insert id="insertStoreOrderItemDetail" parameterType="OrderDetailDTO">
    		insert into order_store_detail 
    		(
    			store_order_detail_id,
			    store_order_qty,
			    store_order_price,
			    store_order_amount,
			    store_order_created_at,
			    vendor_code,
			    store_order_id,
			    item_id,
			    store_order_item_code,
			    store_order_item_name
    		)
    		values(null, #{hqOrderQty}, #{hqOrderPrice}, #{hqOrderAmount}, now(), #{vendorCode}, #{hqOrderId}, #{itemId}, #{hqOrderItemCode}, #{hqOrderItemName});
    	</insert>
    	
    	<!-- 발주 목록 요청 -->
    	<select id="listHq" resultType="OrderDTO">
    		select * from order_hq
			    where hq_order_status in
			    <foreach collection="statuses"
			             item="status"
			             open="("
			             separator=","
			             close=")">
			        #{status}
			    </foreach>
    	</select>
    	<select id="listStore" resultType="OrderDTO">
    		select
	        s.store_order_id          as hqOrderId,
	        s.store_order_total_amount as hqOrderTotalAmount,
	        s.member_id               as memberId,
	        s.store_order_approver    as storeOrderApprover,
	        s.store_rejection_reason  as storeRejectionReason,
	        s.store_order_status      as hqOrderStatus
	    	from order_store s
			    where s.store_order_status in
			    <foreach collection="statuses"
			             item="status"
			             open="("
			             separator=","
			             close=")">
			        #{status}
			    </foreach>
    	</select>
    	<!-- 발주 상세 목록 요청 -->
    	<select id="getHqOrderDetail" resultType="OrderDetailDTO">
    		select * from order_hq_detail where hq_order_id = #{orderNo}
    	</select>
    	<select id="getStoreOrderDetail" resultType="OrderDetailDTO">
    		select 
    		store_order_item_name as hqOrderItemName,
    		store_order_qty as hqOrderQty,
    		store_order_price as hqOrderPrice,
    		store_order_amount as hqOrderAmount
    		from order_store_detail where store_order_id = #{orderNo}
    	</select>
    	
    	<!-- 발주 승인 처리 -->
    	<update id="approveHqOrder">
    		update order_hq set hq_order_status = 200, hq_order_approvaled_at = NOW() where hq_order_id = #{orderNo}
    	</update>
    	<update id="approveStoreOrder">
    		update order_store set store_order_status = 200, store_order_approver = #{orderApproverId}, store_order_approvaled_at = NOW() where store_order_id = #{orderNo}
    	</update>
    	<!-- 발주 자동 승인 처리 -->
    	
    	
    	<!-- 반려 처리 -->
    	<update id="rejectOrder" parameterType="OrderRejectDTO">
    		update order_store set store_order_status = 150, store_rejection_reason = #{rejectReason} where store_order_id = #{rejectId}
    	</update>
    	<!-- 반려 처리 알림으로 가맹 점수 아이디 조회 -->
    	<select id="rejectOrderNotification" parameterType="OrderRejectDTO" resultType="OrderRejectDTO">
    		SELECT store_order_id AS rejectId, member_id AS storeMemberId FROM order_store
    		WHERE store_order_id = #{rejectId}
    	</select>
    	
    	<!-- 승인취소 처리 -->
    	<update id="cancelApproveHqOrder" parameterType="String">
    		update order_hq set hq_order_status = 300 where hq_order_id = #{orderNo}
    	</update>
    	<update id="cancelApproveStoreOrder" parameterType="String">
    		update order_store set store_order_status = 300 where store_order_id = #{orderNo}
    	</update>
    	
    	<!-- 입고 처리 -->
    	<update id="receiveHqOrder" parameterType="String">
    		update order_hq set hq_order_status = 400 where hq_order_id = #{orderNo}
    	</update>
    	<update id="receiveStoreOrder">
    		update order_store set store_order_status = 400 where store_order_id = #{orderNo}
    	</update>
    </mapper>