<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.cafe.erp.item.ItemDAO">
    	<!-- 물품 등록, 단가 등록 -->
    	<!-- 물품 등록 / 단가 등록하여 itemId생성하여 단가 등록으로 전달 -->
    	<insert id="add" parameterType="ItemDTO" useGeneratedKeys="true" keyProperty="itemId">
    		insert into vendor_item(item_code, item_name, item_category, item_enable, item_auto_order)
    		values (#{itemCode}, #{itemName}, #{itemCategory}, #{itemEnable}, #{itemAutoOrder})
    	</insert>
    	<!-- 물품코드 max값 가져오기 / itemCode 생성시 필요 -->
    	<select id="max" parameterType="String" resultType="String">
    		select max(item_code) from vendor_item where item_code LIKE CONCAT(#{itemCode},'%')
    	</select>
    	<!-- 단가 등록 -->
    	<insert id="priceAdd" parameterType="ItemDTO">
    		insert into vendor_item_price
    		values (null, #{itemSupplyPrice}, 0, #{itemId}, #{vendorId})
    	</insert>
    	
    	
		<!-- 모든 리스트 -->    	
		<select id="list">
		  SELECT
		  	item_id,
		    item_code,
		    item_name,
		    item_category,
		    item_enable,
		    item_auto_order
		  FROM vendor_item
		</select>
		<!-- 물품 검색 -->
    	<select id="search" resultType="ItemDTO">
		  SELECT
		    vi.item_id as itemId,
		    item_code,
		    item_name,
		    item_category,
		    item_enable,
		    item_auto_order,
		    item_supply_price,
		    item_price_enable
		  FROM vendor_item vi
		  JOIN vendor_item_price vip ON vi.item_id = vip.item_id 
		  LEFT JOIN vendor v ON v.vendor_id = vip.vendor_id
		  WHERE 1=1
		  <if test="itemName != null and itemName != ''">
		    AND item_name LIKE CONCAT('%', #{itemName}, '%')
		  </if>
		  <if test="category != null and category != ''">
		    AND item_code LIKE CONCAT(#{category}, '%')
		  </if>
		  <if test="vendorCode != null and vendorCode != ''">
		    AND vendor_code = #{vendorCode}
		  </if>
		</select>
    	
    	<!-- 물품 정보 업데이트 -->
    	<update id="updateItem" parameterType="ItemDTO">
    		update vendor_item set item_name=#{itemName}, item_enable=#{itemEnable}, item_auto_order=#{itemAutoOrder} where item_id = #{itemId};
    	</update>
    	
    	<!-- 단가 목록 -->
    	<select id="priceList" resultType="ItemPriceDetailDTO">
    		select vi.item_id as itemId,
					vi.item_code as itemCode,
			        vi.item_name as itemName,
			        vi.item_category as itemCategory,
			        vi.item_enable as itemEnable,
			        vi.item_auto_order as itemAutoOrder,
			        vip.item_supply_price as itemSupplyPrice, 
			        vip.item_price_enable as itemPriceEnable,
			        v.vendor_id as vendorId,
			        v.vendor_name as vendorName,
			        v.vendor_code as vendorCode
			from vendor_item vi 
			join vendor_item_price vip on vi.item_id = vip.item_id 
			left join vendor v on v.vendor_id = vip.vendor_id
			ORDER BY
			SUBSTRING(vi.item_code, 1, 2),
			CAST(SUBSTRING(vi.item_code, 3) AS UNSIGNED)
    	</select>
    	
    </mapper>
    
   